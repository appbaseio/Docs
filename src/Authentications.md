# User Authentication

Most applications need to know the identity of a user. Knowing a user's identity allows an app to provide a customized experience. The process of proving a user's identity is called _authentication_.

Appbase makes authentication easy with completely client-side code. It has built-in functionality for third-party providers such as Facebook, LinkedIn, GitHub, Dropbox, and Google.

When a user authenticates to an Appbase app, the information about the user is returned in callbacks on the client device. This allows you to customize your app's user experience for that specific user. Appbase also issues a __requestObject__, which makes it easy for you to access the providers' data APIs.

Once a user authenticates to your app, Appbase manages their session, ensuring that the user is remembered across page refreshes and browser restarts.

## Configuring Login

For security reasons, only domains that you whitelist are allowed to initiate authentication for your app.  All Appbase apps have localhost and 127.0.0.1 enabled by default for local development and testing. Add more authorized origins to enable authentication from domains where your host your app.

1. Navigate to the [Appbase Developer Console](http://appbase.io/developer/).
2. Open the Authentication tab.
3. Select your app and add all of the domains that host your app to the Authorized domains field.

## Enabling Providers

Next, you need to enable the provider that you selected for your Appbase.

1. Navigate to the [Appbase Developer Console](http://appbase.io/developer/).
2. Open the Authentication tab.
3. Select your app and click _Add_ on the provider.
4. Copy the _client ID_ and _secret_ from your provider, into the form.
5. Add the appbase domain and callback URL specified on the page, to your application settings on the provider's page.

Appbase is all set up for your provider. It's time to code.

## Logging User In

The following code shows a popup and retrieves the user's credentials for Appbase, and Facebook.
```js
Appbase.authPopup('facebook', function(error, authObj, requestObj) {
    if(error) {
      console.log('Error occured:', error);
    } else {
	  console.log('Logged in as:', authObj.uid); 
    }
});
```
Appbase automatically retrieves the basic information about the user (the _me_ data) from the provider, the access tokens for Appbase and the provider and present it as the _authObj_.
`authObj` is a JSON object:
```json
{
	uid: "User's id as generated by the provider",
	firtsname: "First name of the user",
	lastname: "Last name of the user",
	email: "Email id of the user",
	avatar: "URL to the profile picture of the user",
	raw: {the raw `me` data retrieved from the provider},
	credentials: {
		appbase: {
			access_token: "access token to access appbase REST api",
			expires_in: time in seconds,
			generated_at: time since epoch in milliseconds
		},
		provider: {
			provider: "name of the provider",
			access_token: "access token to access provider's data API",
			expires_in: time in seconds,
			generated_at: time since epoch in milliseconds 
		}
	}
}
```
Appbase stores and uses these tokens for accessing appbase REST api, and provider's data APIs.

## Accessing provider's data APIs
`requestObj` returned in the authentication can be used to you to perform API calls to a provider. It contains methods that wrap the usual HTTP methods: `.get()`, `.post()`, `.put()`, `.patch()`, and `.del()`.
```js
requestObj.get('/api/endpoint', function(error, data) {
	...
});
requestObj.post('/api/endpoint', {
		data: {
			post_field: 'value',
	        // ...
		}
	}, function(error, response) {
	}
);
```
## Dealing with Popups and Redirects

Appbase supports two different ways to authenticate with OAuth providers - via pop-up, or browser redirect.

Third-party authentication methods use a browser pop-up window, or browser redirect, to prompt the user to sign-in, approve the application, and return the user's data to the requesting application.

Most modern browsers block pop-up windows unless they are invoked by direct user action. Therefore, we should only invoke the `authPopup()` method for third-party authentication upon the user's click, otherwise `authRedirect()` should be used.

`authRedirect()` redirects to the provider's login page, where the user can accept your app's permissions. Once he has, he is redirected to the callback url.

```js
Appbase.authRedirect('provider', 'http://yoururl.com/callback');
```

After this call, at the page where the redirect URL points, call `authCallback()`, which allows you to retrieve the credentials.

```js
//At the page where callback URL points
Appbase.authCallback(function(error, authObj, requestObj) {
    if(error) {
      console.log('Error occured:', error);
    } else {
	  console.log('Logged in as:', authObj.uid); 
    }
});
```

## Working with Scopes, and additional parameters
Providers require different scope parameters, to access the user's data on their APIs. 
For eg. 

- The scope _openid_ is required for Google, in order to retrieve the user's ID and basic information, otherwise, user's id is not accessible and `Appbase.authPopup()` will throw  error: "user's id not present".
- LinkedIn requires *r_emailaddress* scope, to access the email address of the user. Without specifying this scope, the `authObj` will not contain _email_ field.

Providers might even require additional parameters, which can be defined in the options to `Appbase.authPopup()` ,along with the _scope_:
```js
Appbase.authPopup('google', {
	authorize: {
			scope: ['openid']
			//define additional paramters required for the provider here
		}
	}, callback);

Appbase.authPopup('linkedin', {
	authorize: {
			scope: ['r_emailaddress']
		}
	}, callback);
```

Findout the different configurations, scopes and code samples for all the providers [here](/docs/auth_providers-samples.md).

## Logging Users Out
```js
Appbase.unauth();
```

This will remove the credentials from memory and all the requests to Appbase server and, and provider's API will fail.

## Code Samples

Findout code samples for all the providers [here](/docs/auth_providers-samples.md).

# Authentication - additional guide

Every provider requires Oauth paramters to be passed while authenticating. Mostly, they are the same across all providers, for eg. redirect_url, token_type, client_id etc. Appbase takes care of these paramters, except for some cases, which depends on the developer's need. This document explains how to provide these paramters while authenticating with Appbase and a provider, plus provides links to provider's additional documentation.

You can directly use the code snippets given here for a provider, and the authentication will work out of the box.

## Scopes

Scoping allows OAuth clients to tell an authorization server what permissions they’ll need on resources they’re accessing. The required scopes, can be specified while calling `Appbase.authPopup()`, and then we can access the data using `requestObject`, and calling provider's data endpoints.

## Google

### Required paramters

* __scope__: 'openid', which allows us to access basic information about the user.

### Minimal Code

```js
Appbase.authPopup('google', { authorize: { scope: ['openid'] } }, function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
});
```

### Additional docs

Find out more about scopes and API endpoints supported by Google [here](https://developers.google.com/+/api/oauth#scopes).

### Calling APIs

```js
Appbase.authPopup('google', { authorize: { scope: ['openid email profile'] } }, function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
    request.get('plus/v1/people/me', function(error, data) { // requests the profile of the user
        ...
    });
});
```

## Facebook

### Minimal Code

```js
Appbase.authPopup('facebook', function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
});
```

### Additional docs

Find out more about scopes and API endpoints supported by Facebook [here](https://developers.facebook.com/docs/facebook-login/permissions/v2.1).


## LinkedIn

### Minimal Code

```js
Appbase.authPopup('linkedin', function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
});
```

### Additional docs

Find out more about scopes and API endpoints supported by LinkedIn [here](https://developer.linkedin.com/documents/authentication#granting).


## Github

### Minimal Code

```js
Appbase.authPopup('github', function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
});
```

### Additional docs

Find out more about scopes and API endpoints supported by Github [here](https://developer.github.com/v3/oauth/#scopes).



## Dropbox

### Minimal Code

```js
Appbase.authPopup('dropbox', function(error, authObj, requestObj) {
    console.log('Logged in as:', authObj.uid);
});
```

### Additional docs

Find out more about API endpoints supported by Dropbox [here](https://www.dropbox.com/developers/core/docs#account-info).
